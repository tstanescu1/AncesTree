import { v } from "convex/values";
import { mutation, query } from "./_generated/server";
import { Id } from "./_generated/dataModel";

// Mock AI response generator for medicinal questions
// In a real app, this would integrate with OpenAI, Claude, or similar AI service
const generateMedicinalResponse = async (
  plantName: string,
  scientificName: string,
  traditionalUsage: string,
  medicinalTags: string[],
  question: string
): Promise<string> => {
  
  const questionLower = question.toLowerCase();
  const plantDisplayName = plantName || scientificName || 'this plant';
  
  // Comprehensive response templates based on question type
  if (questionLower.includes('prepare') || questionLower.includes('preparation') || questionLower.includes('how to make')) {
    return `**Traditional Preparation Methods for ${plantDisplayName}**\n\n` +
           `Based on traditional knowledge, here are common preparation methods:\n\n` +
           `üåø **Tea/Infusion**\n` +
           `‚Ä¢ Use 1-2 teaspoons of dried herb per cup of hot water\n` +
           `‚Ä¢ Steep for 10-15 minutes, covered\n` +
           `‚Ä¢ Strain and drink 1-3 times daily\n\n` +
           `üç∂ **Tincture**\n` +
           `‚Ä¢ Soak plant material in 80-100 proof alcohol\n` +
           `‚Ä¢ Use 1:5 ratio (1 part herb to 5 parts alcohol)\n` +
           `‚Ä¢ Let steep for 2-6 weeks in dark location\n` +
           `‚Ä¢ Strain and store in dark glass bottles\n\n` +
           `üî• **Decoction** (for roots, bark, seeds)\n` +
           `‚Ä¢ Simmer 1 tablespoon herb in 2 cups water\n` +
           `‚Ä¢ Boil for 20-30 minutes\n` +
           `‚Ä¢ Strain and drink warm\n\n` +
           `üíÜ **Poultice** (external use)\n` +
           `‚Ä¢ Crush fresh plant material\n` +
           `‚Ä¢ Apply directly to affected area\n` +
           `‚Ä¢ Cover with clean cloth\n\n` +
           `‚ö†Ô∏è **Safety**: Always start with small amounts and consult healthcare providers.`;
  }
  
  if (questionLower.includes('parts') || questionLower.includes('used') || questionLower.includes('which part')) {
    const commonParts = ['leaves', 'flowers', 'roots', 'bark', 'seeds', 'berries', 'stems'];
    const mentionedParts = commonParts.filter(part => 
      traditionalUsage.toLowerCase().includes(part) || 
      medicinalTags.some(tag => tag.toLowerCase().includes(part))
    );
    
    return `**Medicinal Parts of ${plantDisplayName}**\n\n` +
           `Traditional medicine uses these parts:\n\n` +
           `${mentionedParts.length > 0 ? mentionedParts.map(part => `‚Ä¢ **${part.charAt(0).toUpperCase() + part.slice(1)}**: ${getPartDescription(part)}`).join('\n') : 
           '‚Ä¢ **Various parts** depending on the preparation and intended use'}\n\n` +
           `**General Guidelines:**\n` +
           `‚Ä¢ **Leaves & Flowers**: Usually harvested in spring/summer, used fresh or dried\n` +
           `‚Ä¢ **Roots & Bark**: Typically harvested in fall/winter, often dried\n` +
           `‚Ä¢ **Seeds & Berries**: Harvested when mature, can be used fresh or dried\n\n` +
           `**Harvesting Tips:**\n` +
           `‚Ä¢ Choose healthy, disease-free plants\n` +
           `‚Ä¢ Harvest in morning after dew dries\n` +
           `‚Ä¢ Leave enough for plant regeneration\n` +
           `‚Ä¢ Follow sustainable practices`;
  }
  
  if (questionLower.includes('safety') || questionLower.includes('precaution') || questionLower.includes('dangerous')) {
    return `**‚ö†Ô∏è Safety Precautions for ${plantDisplayName}**\n\n` +
           `**Essential Safety Guidelines:**\n\n` +
           `üîç **Identification**:\n` +
           `‚Ä¢ Always identify the plant correctly before use\n` +
           `‚Ä¢ Use multiple identification methods\n` +
           `‚Ä¢ When in doubt, don't use it\n\n` +
           `‚öñÔ∏è **Dosage Safety**:\n` +
           `‚Ä¢ Start with very small amounts\n` +
           `‚Ä¢ Test for allergic reactions\n` +
           `‚Ä¢ Never exceed recommended doses\n` +
           `‚Ä¢ Individual responses vary greatly\n\n` +
           `üö´ **Contraindications**:\n` +
           `‚Ä¢ Pregnancy and breastfeeding (consult doctor)\n` +
           `‚Ä¢ Children under 12 (consult pediatrician)\n` +
           `‚Ä¢ Elderly individuals (start with lower doses)\n` +
           `‚Ä¢ People with liver/kidney conditions\n` +
           `‚Ä¢ Those taking medications (check interactions)\n\n` +
           `üÜò **Emergency Signs**:\n` +
           `‚Ä¢ Stop immediately if you experience:\n` +
           `  - Rash, itching, or swelling\n` +
           `  - Difficulty breathing\n` +
           `  - Nausea, vomiting, or diarrhea\n` +
           `  - Dizziness or confusion\n\n` +
           `**This information is for educational purposes only. Always consult qualified healthcare providers.**`;
  }
  
  if (questionLower.includes('dosage') || questionLower.includes('how much') || questionLower.includes('amount')) {
    return `**üìè Dosage Guidelines for ${plantDisplayName}**\n\n` +
           `**Standard Dosage Recommendations:**\n\n` +
           `‚òï **Tea/Infusion**:\n` +
           `‚Ä¢ 1-2 cups per day\n` +
           `‚Ä¢ 1 teaspoon dried herb per cup\n` +
           `‚Ä¢ Steep 10-15 minutes\n\n` +
           `üíß **Tincture**:\n` +
           `‚Ä¢ 10-30 drops, 2-3 times daily\n` +
           `‚Ä¢ Dilute in water or juice\n` +
           `‚Ä¢ Start with lower dose\n\n` +
           `üíä **Capsules**:\n` +
           `‚Ä¢ Follow manufacturer's instructions\n` +
           `‚Ä¢ Usually 1-2 capsules, 2-3 times daily\n\n` +
           `üñêÔ∏è **Topical Use**:\n` +
           `‚Ä¢ Apply as needed for external conditions\n` +
           `‚Ä¢ Test on small area first\n\n` +
           `**‚ö†Ô∏è Important Notes:**\n` +
           `‚Ä¢ Start with the lowest recommended dose\n` +
           `‚Ä¢ Individual responses vary significantly\n` +
           `‚Ä¢ Consult healthcare provider for personalized advice\n` +
           `‚Ä¢ Not a substitute for professional medical care\n` +
           `‚Ä¢ Monitor your response and adjust accordingly`;
  }
  
  if (questionLower.includes('effects') || questionLower.includes('how long') || questionLower.includes('timeline')) {
    return `**‚è∞ Expected Effects and Timeline for ${plantDisplayName}**\n\n` +
           `**Typical Response Timeline:**\n\n` +
           `‚ö° **Immediate Effects** (within hours):\n` +
           `‚Ä¢ Some preparations may provide quick relief\n` +
           `‚Ä¢ Calming effects from teas\n` +
           `‚Ä¢ Topical relief from poultices\n\n` +
           `üìà **Short-term** (1-2 weeks):\n` +
           `‚Ä¢ Gradual improvement in symptoms\n` +
           `‚Ä¢ Building up therapeutic levels\n` +
           `‚Ä¢ Body adjusting to the herb\n\n` +
           `üéØ **Long-term** (1-3 months):\n` +
           `‚Ä¢ Full therapeutic benefits\n` +
           `‚Ä¢ Systemic improvements\n` +
           `‚Ä¢ Optimal healing response\n\n` +
           `**Factors Affecting Response:**\n` +
           `‚Ä¢ Preparation method used\n` +
           `‚Ä¢ Individual constitution and health\n` +
           `‚Ä¢ Condition being treated\n` +
           `‚Ä¢ Quality and freshness of plant material\n` +
           `‚Ä¢ Consistency of use\n\n` +
           `**Monitoring Your Response:**\n` +
           `‚Ä¢ Keep a journal of effects\n` +
           `‚Ä¢ Note any side effects\n` +
           `‚Ä¢ Adjust dosage as needed\n` +
           `‚Ä¢ Consult healthcare provider if concerns arise`;
  }
  
  if (questionLower.includes('combine') || questionLower.includes('herbs') || questionLower.includes('mix')) {
    return `**üåø Combining ${plantDisplayName} with Other Herbs**\n\n` +
           `**Common Herbal Combinations:**\n\n` +
           `üòå **Calming Combinations**:\n` +
           `‚Ä¢ Chamomile + Lavender + Valerian\n` +
           `‚Ä¢ Lemon Balm + Passionflower\n` +
           `‚Ä¢ Skullcap + Hops\n\n` +
           `ü´Å **Respiratory Support**:\n` +
           `‚Ä¢ Thyme + Eucalyptus + Peppermint\n` +
           `‚Ä¢ Mullein + Coltsfoot + Licorice\n` +
           `‚Ä¢ Elderberry + Ginger + Honey\n\n` +
           `ü©∏ **Immune Support**:\n` +
           `‚Ä¢ Echinacea + Astragalus + Elderberry\n` +
           `‚Ä¢ Garlic + Ginger + Turmeric\n` +
           `‚Ä¢ Reishi + Chaga + Turkey Tail\n\n` +
           `üíö **Digestive Support**:\n` +
           `‚Ä¢ Ginger + Peppermint + Fennel\n` +
           `‚Ä¢ Chamomile + Marshmallow + Slippery Elm\n` +
           `‚Ä¢ Dandelion + Milk Thistle + Burdock\n\n` +
           `**‚ö†Ô∏è Important Guidelines:**\n` +
           `‚Ä¢ Research interactions before combining\n` +
           `‚Ä¢ Start with one herb at a time\n` +
           `‚Ä¢ Consult with qualified herbalist\n` +
           `‚Ä¢ Some combinations may enhance or reduce effects\n` +
           `‚Ä¢ Be aware of potential contraindications`;
  }
  
  if (questionLower.includes('contraindication') || questionLower.includes('avoid') || questionLower.includes('not safe')) {
    return `**üö´ Contraindications for ${plantDisplayName}**\n\n` +
           `**When to Avoid This Plant:**\n\n` +
           `ü§∞ **Pregnancy & Breastfeeding**:\n` +
           `‚Ä¢ Avoid unless specifically approved by healthcare provider\n` +
           `‚Ä¢ Many herbs can affect pregnancy\n` +
           `‚Ä¢ Some may pass into breast milk\n\n` +
           `üë∂ **Children**:\n` +
           `‚Ä¢ Children under 12 should avoid unless approved by pediatrician\n` +
           `‚Ä¢ Children's bodies process herbs differently\n` +
           `‚Ä¢ Lower body weight means higher risk\n\n` +
           `üè• **Medical Conditions**:\n` +
           `‚Ä¢ Liver or kidney disease\n` +
           `‚Ä¢ Heart conditions\n` +
           `‚Ä¢ Autoimmune disorders\n` +
           `‚Ä¢ Diabetes (may affect blood sugar)\n` +
           `‚Ä¢ Bleeding disorders\n\n` +
           `üíä **Medication Interactions**:\n` +
           `‚Ä¢ Blood thinners\n` +
           `‚Ä¢ Diabetes medications\n` +
           `‚Ä¢ Blood pressure medications\n` +
           `‚Ä¢ Sedatives or antidepressants\n` +
           `‚Ä¢ Always check with pharmacist or doctor\n\n` +
           `üîç **Allergies**:\n` +
           `‚Ä¢ Known allergies to this plant family\n` +
           `‚Ä¢ Cross-reactions with related plants\n` +
           `‚Ä¢ Environmental allergies that may be aggravated\n\n` +
           `**Always consult healthcare provider before use, especially if you have any medical conditions or take medications.**`;
  }
  
  if (questionLower.includes('store') || questionLower.includes('storage') || questionLower.includes('preserve')) {
    return `**üì¶ Storage Guidelines for ${plantDisplayName}**\n\n` +
           `**Optimal Storage Conditions:**\n\n` +
           `üåø **Dried Herbs**:\n` +
           `‚Ä¢ Store in airtight glass containers\n` +
           `‚Ä¢ Keep in cool, dark, dry location\n` +
           `‚Ä¢ Avoid direct sunlight and moisture\n` +
           `‚Ä¢ Use within 1-2 years for best potency\n` +
           `‚Ä¢ Label with harvest date\n\n` +
           `üç∂ **Tinctures**:\n` +
           `‚Ä¢ Store in dark glass bottles\n` +
           `‚Ä¢ Keep in cool, dark location\n` +
           `‚Ä¢ Refrigerate for longer shelf life\n` +
           `‚Ä¢ Use within 3-5 years\n` +
           `‚Ä¢ Check for cloudiness or off-odors\n\n` +
           `ü´ô **Oils & Salves**:\n` +
           `‚Ä¢ Store in dark glass containers\n` +
           `‚Ä¢ Keep in refrigerator\n` +
           `‚Ä¢ Use within 6-12 months\n` +
           `‚Ä¢ Check for rancidity\n\n` +
           `üå± **Fresh Preparations**:\n` +
           `‚Ä¢ Refrigerate and use within 1 week\n` +
           `‚Ä¢ Freeze for longer storage\n` +
           `‚Ä¢ Label with preparation date\n` +
           `‚Ä¢ Discard if mold or off-odors develop\n\n` +
           `**Storage Tips:**\n` +
           `‚Ä¢ Keep away from heat sources\n` +
           `‚Ä¢ Maintain consistent temperature\n` +
           `‚Ä¢ Check regularly for signs of spoilage\n` +
           `‚Ä¢ Rotate stock (first in, first out)`;
  }
  
  if (questionLower.includes('harvest') || questionLower.includes('time of year') || questionLower.includes('when to pick')) {
    return `**üå± Best Harvest Times for ${plantDisplayName}**\n\n` +
           `**Seasonal Harvesting Guide:**\n\n` +
           `üå∏ **Spring Harvest** (March-May):\n` +
           `‚Ä¢ New leaves and shoots\n` +
           `‚Ä¢ Early flowers and buds\n` +
           `‚Ä¢ Fresh, tender growth\n` +
           `‚Ä¢ Highest in vitamins and minerals\n\n` +
           `‚òÄÔ∏è **Summer Harvest** (June-August):\n` +
           `‚Ä¢ Full blooms and flowers\n` +
           `‚Ä¢ Peak medicinal compounds\n` +
           `‚Ä¢ Mature leaves\n` +
           `‚Ä¢ Optimal essential oil content\n\n` +
           `üçÇ **Fall Harvest** (September-November):\n` +
           `‚Ä¢ Roots and rhizomes\n` +
           `‚Ä¢ Seeds and berries\n` +
           `‚Ä¢ Bark (if applicable)\n` +
           `‚Ä¢ Plants storing energy for winter\n\n` +
           `‚ùÑÔ∏è **Winter Harvest** (December-February):\n` +
           `‚Ä¢ Dormant roots\n` +
           `‚Ä¢ Evergreen leaves\n` +
           `‚Ä¢ Bark from deciduous trees\n` +
           `‚Ä¢ Limited but valuable harvests\n\n` +
           `**Harvesting Best Practices:**\n` +
           `‚Ä¢ Harvest in morning after dew dries\n` +
           `‚Ä¢ Choose healthy, disease-free plants\n` +
           `‚Ä¢ Leave enough for plant regeneration\n` +
           `‚Ä¢ Follow sustainable harvesting practices\n` +
           `‚Ä¢ Respect local regulations and private property`;
  }
  
  // Default comprehensive response
  return `**üåø About ${plantDisplayName}**\n\n` +
         `Thank you for your question about ${plantDisplayName}!\n\n` +
         `**Traditional Knowledge:**\n` +
         `${traditionalUsage || 'This plant has been used in traditional medicine for various purposes.'}\n\n` +
         `**Medicinal Properties:**\n` +
         `${medicinalTags.length > 0 ? medicinalTags.join(', ') : 'Various traditional medicinal properties'}\n\n` +
         `**For Specific Information, Ask About:**\n` +
         `‚Ä¢ Preparation methods and recipes\n` +
         `‚Ä¢ Which parts of the plant to use\n` +
         `‚Ä¢ Safety precautions and contraindications\n` +
         `‚Ä¢ Dosage guidelines\n` +
         `‚Ä¢ Expected effects and timeline\n` +
         `‚Ä¢ Combining with other herbs\n` +
         `‚Ä¢ Storage and preservation\n` +
         `‚Ä¢ Best harvesting times\n\n` +
         `**‚ö†Ô∏è Important:** Always consult with qualified healthcare providers before using any medicinal plants. This information is for educational purposes and traditional knowledge sharing.`;
};

const getPartDescription = (part: string): string => {
  const descriptions: { [key: string]: string } = {
    leaves: 'Often used for teas, infusions, and tinctures',
    flowers: 'Used in tinctures, salves, and teas',
    roots: 'Typically prepared as decoctions or tinctures',
    bark: 'Used in traditional medicine preparations',
    seeds: 'Can be used whole, ground, or as oils',
    berries: 'Used fresh, dried, or in syrups',
    stems: 'Sometimes used in teas and preparations'
  };
  return descriptions[part] || 'Used in various traditional preparations';
};

// Build comprehensive context for medicinal Q&A
function buildMedicinalContext(
  plant: any, 
  allSightings: any[], 
  plantFeedback: any[],
  plantRejections: any[],
  collectionStats: any
): string {
  let context = `**Plant Information:**\n`;
  context += `- Scientific Name: ${plant.scientificName}\n`;
  context += `- Common Names: ${plant.commonNames?.join(', ') || 'Unknown'}\n`;
  context += `- Traditional Usage: ${plant.traditionalUsage || 'Traditional uses being documented'}\n`;
  context += `- Medicinal Properties: ${plant.medicinalTags?.join(', ') || 'Various traditional properties'}\n`;
  
  if (plant.growingConditions) context += `- Growing Conditions: ${plant.growingConditions}\n`;
  if (plant.seasonInfo) context += `- Seasonal Information: ${plant.seasonInfo}\n`;
  if (plant.toxicity) context += `- Safety Notes: ${plant.toxicity}\n`;
  if (plant.otherDetails) context += `- Additional Details: ${plant.otherDetails}\n`;
  
  // Collection context
  if (allSightings.length > 0) {
    context += `\n**Your Collection Context:**\n`;
    context += `- Total sightings of this plant: ${allSightings.length}\n`;
    
    const locations = allSightings.filter(s => s.latitude && s.longitude);
    if (locations.length > 0) {
      context += `- Found in ${locations.length} different locations\n`;
    }
    
    const experiences = allSightings.filter(s => s.userExperience);
    if (experiences.length > 0) {
      context += `- ${experiences.length} sightings with personal experiences documented\n`;
    }
  }

  // Plant feedback context
  if (plantFeedback.length > 0) {
    context += `\n**Your Feedback & Experiences:**\n`;
    plantFeedback.forEach((feedback, index) => {
      context += `- Feedback ${index + 1}: ${feedback.feedback}\n`;
    });
  }

  // Plant rejections context (learning from mistakes)
  if (plantRejections.length > 0) {
    context += `\n**Related Identification Challenges:**\n`;
    context += `- You've encountered ${plantRejections.length} similar plants that were misidentified\n`;
    plantRejections.forEach((rejection, index) => {
      context += `- Rejected as: ${rejection.rejectedPlantName}\n`;
    });
  }

  // Overall collection statistics
  context += `\n**Your Overall Collection:**\n`;
  context += `- Total plants in your collection: ${collectionStats.totalPlants}\n`;
  context += `- Total sightings across all plants: ${collectionStats.totalSightings}\n`;
  context += `- Plants with documented experiences: ${collectionStats.plantsWithFeedback}\n`;
  context += `- Total feedback entries: ${collectionStats.totalFeedback}\n`;
  
  return context;
}

// Generate medicinal response with enhanced context
async function generateMedicinalResponseWithContext(
  plantName: string,
  scientificName: string,
  traditionalUsage: string,
  medicinalTags: string[],
  question: string,
  context: string
): Promise<string> {
  // Log the context for debugging
  console.log("=== MEDICINAL Q&A CONTEXT DEBUG ===");
  console.log("Plant:", scientificName);
  console.log("Context Length:", context.length);
  console.log("Question:", question);
  console.log("=== END MEDICINAL Q&A CONTEXT DEBUG ===");

  // For now, use the existing response generation but include context
  const baseResponse = await generateMedicinalResponse(
    plantName,
    scientificName,
    traditionalUsage,
    medicinalTags,
    question
  );

  // Add context information to the response
  return `${baseResponse}\n\n**Your Personal Context:**\n${context}`;
}

export const askMedicinalQuestion = query({
  args: {
    plantId: v.id("plants"),
    question: v.string(),
  },
  handler: async (ctx, args) => {
    console.log("üåø MEDICINAL Q&A FUNCTION CALLED - ENHANCED VERSION");
    console.log("üö® MEDICINAL Q&A NEW VERSION - IF YOU SEE THIS, THE DEPLOYMENT WORKED!");
    
    // Get comprehensive plant and user data
    const plant = await ctx.db.get(args.plantId);
    if (!plant) {
      throw new Error("Plant not found");
    }

    // Get all sightings for this plant
    const allSightings = await ctx.db
      .query("sightings")
      .withIndex("plantId", (q) => q.eq("plantId", args.plantId))
      .collect();

    // Get plant feedback
    const plantFeedback = await ctx.db
      .query("plant_feedback")
      .withIndex("plantId", (q) => q.eq("plantId", args.plantId))
      .collect();

    // Get plant rejections (related plants that were misidentified)
    const allRejections = await ctx.db
      .query("plant_rejections")
      .collect();
    
    const plantRejections = allRejections.filter(rejection => {
      const plantNames = [plant.scientificName, ...(plant.commonNames || [])];
      return plantNames.some(name => 
        rejection.rejectedPlantName.toLowerCase().includes(name.toLowerCase()) ||
        name.toLowerCase().includes(rejection.rejectedPlantName.toLowerCase())
      );
    });

    // Get collection statistics
    const allPlants = await ctx.db.query("plants").collect();
    const allSightingsTotal = await ctx.db.query("sightings").collect();
    const allFeedback = await ctx.db.query("plant_feedback").collect();
    const allRejectionsTotal = await ctx.db.query("plant_rejections").collect();
    
    const collectionStats = {
      totalPlants: allPlants.length,
      totalSightings: allSightingsTotal.length,
      totalFeedback: allFeedback.length,
      totalRejections: allRejectionsTotal.length,
      plantsWithSightings: new Set(allSightingsTotal.map(s => s.plantId)).size,
      plantsWithFeedback: new Set(allFeedback.map(f => f.plantId)).size,
    };

    // Log the data retrieved from database
    console.log("=== MEDICINAL Q&A - DATABASE QUERY RESULTS ===");
    console.log("Plant retrieved:", !!plant);
    console.log("All Sightings retrieved:", allSightings.length);
    console.log("Plant Feedback retrieved:", plantFeedback.length);
    console.log("Plant Rejections retrieved:", plantRejections.length);
    console.log("Collection Stats retrieved:", !!collectionStats);
    console.log("=== END MEDICINAL Q&A DATABASE QUERIES ===");

    // Build comprehensive context
    const context = buildMedicinalContext(plant, allSightings, plantFeedback, plantRejections, collectionStats);
    
    // Generate response with enhanced context
    const response = await generateMedicinalResponseWithContext(
      plant.commonNames?.[0] || plant.scientificName,
      plant.scientificName,
      plant.traditionalUsage || "",
      plant.medicinalTags || [],
      args.question,
      context
    );

    return {
      response,
      plantName: plant.commonNames?.[0] || plant.scientificName,
      timestamp: Date.now()
    };
  },
});

// Store Q&A interactions for learning
export const storeMedicinalQA = mutation({
  args: {
    plantId: v.id("plants"),
    question: v.string(),
    response: v.string(),
    userId: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    // In a real app, you might store this in a separate table
    // for analytics and improving responses
    console.log("Storing Q&A interaction:", {
      plantId: args.plantId,
      question: args.question,
      response: args.response,
      userId: args.userId,
      timestamp: Date.now()
    });
    
    return { success: true };
  },
}); 